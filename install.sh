#!/bin/bash

# ============================================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# ============================================

# !!! –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û !!! URL –≤–∞—à–µ–≥–æ dotfiles —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
DOTFILES_REPO="https://github.com/brotigen23/dotfiles.git"

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –≥–¥–µ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è bare —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
DOTFILES_DIR="$HOME/.dotfiles"

# –ò–º—è –≤–µ—Ç–∫–∏ –¥–ª—è —á–µ–∫–∞—É—Ç–∞
BRANCH_NAME="main"

# ============================================
# –§—É–Ω–∫—Ü–∏–∏
# ============================================

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
log() {
    echo -e "\n\033[1m$1\033[0m" # –í—ã–¥–µ–ª–µ–Ω–∏–µ –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ git –≤ bare —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
# –≠—Ç–æ –≤–∞—à –≥–ª–∞–≤–Ω—ã–π —Ä–∞–±–æ—á–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
dotfiles_cmd() {
    /usr/bin/git --git-dir="$DOTFILES_DIR" --work-tree="$HOME" "$@"
}

# ============================================
# –û—Å–Ω–æ–≤–Ω–æ–µ —Ç–µ–ª–æ —Å–∫—Ä–∏–ø—Ç–∞
# ============================================

## 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Git
if ! command -v git &> /dev/null; then
    log "‚ùå Git –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Git –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–∞."
    exit 1
fi

## 2. –ü—Ä–æ–≤–µ—Ä–∫–∞, –±—ã–ª –ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–∞ —Ö–æ—Å—Ç–µ)
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ bare-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
# –ï—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –º—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ dotfiles —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, 
# –∏ —ç—Ç–æ –ª–∏–±–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫, –ª–∏–±–æ –∑–∞–ø—É—Å–∫ –Ω–∞ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ.
if [ -d "$DOTFILES_DIR" ]; then
    log "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π bare-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ($DOTFILES_DIR)."
    log "   –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É."
    log "   –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: 'dotfiles pull' (–ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–ª–∏–∞—Å–∞)."
    exit 0
fi

## 3. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Bare –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
log "‚öôÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ $DOTFILES_REPO –∫–∞–∫ bare-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ $DOTFILES_DIR..."
git clone --bare "$DOTFILES_REPO" "$DOTFILES_DIR"

if [ $? -ne 0 ]; then
    log "‚ùå –û—à–∏–±–∫–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –í—ã—Ö–æ–¥."
    exit 1
fi

## 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git
log "üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å HOME –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π..."

# –£–∫–∞–∑—ã–≤–∞–µ–º Git, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª –Ω–µ—Ç—Ä–µ–∫–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã –≤ $HOME
dotfiles_cmd config --local status.showUntrackedFiles no

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∂–µ–ª–∞–µ–º—É—é –≤–µ—Ç–∫—É
dotfiles_cmd branch -M "$BRANCH_NAME"

## 5. Checkout (–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö dotfiles –≤ $HOME –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤..."

# –ü–æ–ø—ã—Ç–∫–∞ —á–µ–∫–∞—É—Ç–∞ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤, –≤—ã–∑—ã–≤–∞—é—â–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç
CONFLICTS=$(dotfiles_cmd checkout "$BRANCH_NAME" 2>&1 | grep -E "(error|fatal): checkout" | grep -v 'pathspec')

if [ -n "$CONFLICTS" ]; then
    log "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã! –°–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã –≤ $HOME –±–ª–æ–∫–∏—Ä—É—é—Ç —á–µ–∫–∞—É—Ç:"
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, ".zshrc")
    FILES_TO_MOVE=$(echo "$CONFLICTS" | grep -oE "error: checkout.*would be overwritten by merge: \..*" | awk '{print $NF}')

    log "   –ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ —ç—Ç–∏ —Ñ–∞–π–ª—ã –≤ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é:"
    echo "$FILES_TO_MOVE"
    
    log "   ‚ö†Ô∏è –í—ã—Ö–æ–¥. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤."
    exit 1
fi

# –§–∏–Ω–∞–ª—å–Ω—ã–π Checkout (–µ—Å–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ—Ç)
log "‚úÖ Checkout —Ñ–∞–π–ª–æ–≤ –∏–∑ –≤–µ—Ç–∫–∏ $BRANCH_NAME –≤ $HOME..."
dotfiles_cmd checkout "$BRANCH_NAME"

# ============================================
# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
# ============================================

log "üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ dotfiles –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
log "üõ†Ô∏è –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∞–ª–∏–∞—Å –≤ —Å–≤–æ–π .zshrc –∏–ª–∏ .bashrc:"
echo "alias dotfiles='git --git-dir=$DOTFILES_DIR --work-tree=$HOME'"
log "üí° –ß—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–æ–ª–æ—á–∫—É –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ 'source \$HOME/.–í–ê–®_–§–ê–ô–õ_–û–ë–û–õ–û–ß–ö–ò'"

